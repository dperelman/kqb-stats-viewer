<!doctype html>
<html>
  <head>
<style type="text/css" >
body {
  background: #2b0e50;
  font-family: sans;
  color: white;
}
#github {
  position: absolute;
  top: 0;
  right: 0;
  color: gold;
}
#navigation {
  text-align: center;
}
#navigation button {
  font-size: 3em;
}
#stats .winner {
  text-transform: uppercase;
  background: black;
  text-align: center;
}
#stats .winner.gold-winner {
  color: #ee914b;
  text-shadow: 0 0.07em 2px #b84d1f;
}
#stats .winner.blue-winner {
  color: #40c4f2;
  text-shadow: 0 0.07em 2px #495df1;
}
#stats .winner.unknown-winner {
  color: red;
}
#stats .winner::before, #stats .winner::after {
  margin: 0 1ex;
  text-shadow: none;
}
#stats .winner::before {
  color: #40c4f2;
  direction: rtl;
  unicode-bidi: bidi-override;
}
#stats .winner::after {
  color: #ee914b;
}
#stats .winner.blue-won-0::before, #stats .winner.gold-won-0::after {
  content: "▯▯▯";
}
#stats .winner.blue-won-1::before, #stats .winner.gold-won-1::after {
  content: "▮▯▯";
}
#stats .winner.blue-won-2::before, #stats .winner.gold-won-2::after {
  content: "▮▮▯";
}
#stats .winner.blue-won-3::before, #stats .winner.gold-won-3::after {
  content: "▮▮▮";
}

#stats .playerMatchStats {
  text-shadow: 0 0.1em 1px #854aea;
}

#stats .playerMatchStats .blue, #stats .playerMatchStats .gold {
  display: grid;
  margin: 2em;
}

#stats .playerMatchStats .player {
  grid-row: 1;
  width: 20ex;
  text-align: center;
}

#stats .playerMatchStats .identification .avatar.queen::before {
  content: "👑";
}

#stats .playerMatchStats .identification .avatar.worker::before {
  content: "🐝";
}

#stats .playerMatchStats .summaryStats {
  display: inline-grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  place-items: stretch;
  width: 100%;
  text-align: left;
}

#stats .playerMatchStats .summaryStats div {
  padding: 0.2em;
}

#stats .playerMatchStats .blue .summaryStats div {
  border: 3px solid #3fc1f6;
}

#stats .playerMatchStats .gold .summaryStats div {
  border: 3px solid #efc507;
}

#stats .playerMatchStats .summaryStats span {
  float: right;
  text-align: right;
}

#stats .playerMatchStats .blue {
  color: #03c9ee;
}
#stats .playerMatchStats .blue .summaryStats div {
  background: #4664dd;
}

#stats .playerMatchStats .gold {
  color: #ecc534;
}
#stats .playerMatchStats .gold .summaryStats div {
  background: #c3642b;
}

#stats .playerMatchStats .summaryStats .best {
  color: white;
  font-weight: bold;
}

#stats .playerMatchStats .summaryStats .kills {
  grid-row: 1;
  grid-column: 1;
  border-top-left-radius: 0.5em;
}
#stats .playerMatchStats .summaryStats .kills::before {
  content: "🗡️";
}
#stats .playerMatchStats .summaryStats .deaths {
  grid-row: 2;
  grid-column: 1;
  border-bottom-left-radius: 0.5em;
  border-top: 0 !important;
}
#stats .playerMatchStats .summaryStats .deaths::before {
  content: "💀";
}
#stats .playerMatchStats .summaryStats .berries {
  grid-row: 1;
  grid-column: 2;
  border-top-right-radius: 0.5em;
  border-left: 0 !important;
}
#stats .playerMatchStats .summaryStats .berries::before {
  content: "🫐";
}
#stats .playerMatchStats .summaryStats .snail {
  grid-row: 2;
  grid-column: 2;
  border-bottom-right-radius: 0.5em;
  border-top: 0 !important;
  border-left: 0 !important;
}
#stats .playerMatchStats .summaryStats .snail::before {
  content: "🐌";
}
</style>
    <script language="javascript" >
      async function openFile() {
        let file;
        [file] = await window.showOpenFilePicker({
          types: [
            {
              description: "JSON KQB stats file",
              accept: {
                "application/json": ['.json']
              }
            },
          ],
          excludeAcceptAllOption: true,
          multiple: false,
        });
        if (!file) return;
        document.getElementById("dirhelp").style.display = "none";
        document.getElementById("filename").innerText = file.name;
        displayStats(JSON.parse(await (await file.getFile()).text()));
      }
      let dir;
      let seenFiles;
      let currentFilename;
      let previousFilename;
      let nextFilename;
      async function openDir() {
        dir = await window.showDirectoryPicker();
        if (dir) {
          document.getElementById("dirhelp").style.display = "none";
          document.getElementById("navigation").style.display = "";
          seenFiles = new Map();
          previousFilename = undefined;
          nextFilename = undefined;
          currentFilename = undefined;
          document.getElementById('latest').disabled = false;
          loadLatest();
        }
      }
      async function refreshDir() {
        const newFiles = new Map();
        for await (const entry of dir.values()) {
          if (!seenFiles.has(entry.name)) {
            const timestamp = (await entry.getFile()).lastModified;
            newFiles.set(entry.name, timestamp);
            seenFiles.set(entry.name, timestamp);
          }
        }

        return newFiles;
      }
      async function loadByFilename(filename) {
        document.getElementById("filename").innerText = filename;

        currentFilename = filename;
        const currentTimestamp = seenFiles.get(filename);
        const prevFiles = Array.from(seenFiles.entries())
                          .filter(f => f[1] < currentTimestamp)
        previousFilename = prevFiles.length == 0
                ? undefined
                : prevFiles.reduce((a, b) => a[1]>b[1] ? a : b)[0]
        document.getElementById("prev").disabled = !previousFilename;
        const nextFiles = Array.from(seenFiles.entries())
                          .filter(f => f[1] > currentTimestamp)
        nextFilename = nextFiles.length == 0
                ? undefined
                : nextFiles.reduce((a, b) => a[1]<b[1] ? a : b)[0]
        document.getElementById("next").disabled = !nextFilename;

        const file = await dir.getFileHandle(filename);
        displayStats(JSON.parse(await (await file.getFile()).text()));
      }
      async function loadLatest() {
        const newFiles = await refreshDir();
        const files = newFiles.size > 0 ? newFiles : seenFiles;
        loadByFilename(Array.from(files.entries()).reduce((a, b) => a[1]>b[1] ? a : b)[0]);
      }
      async function loadNext() {
        loadByFilename(nextFilename);
      }
      async function loadPrevious() {
        loadByFilename(previousFilename);
      }

      function displayStats(stats) {
        const div = document.getElementById("stats");
        while (div.firstChild) div.removeChild(div.lastChild);

        const header = document.createElement("h2");
        header.classList.add("winner");
        const goldWins = stats.gameWinners.filter(v => v == 1).length;
        const blueWins = stats.gameWinners.filter(v => v == 2).length;
        header.classList.add("gold-won-" + goldWins);
        header.classList.add("blue-won-" + blueWins);
        if (goldWins == 3) {
          header.classList.add("gold-winner");
          header.innerText = "Gold wins";
        } else if (blueWins == 3) {
          header.classList.add("blue-winner");
          header.innerText = "Blue wins";
        } else {
          header.classList.add("unknown-winner");
          header.innerText = "Incomplete match?";
        }
        div.appendChild(header);

        const teams = ["blue", "gold"];
        const teamMap = {2: "blue", 1: "gold"};
        const players = {};
        for (const team of [2, 1]) {
          const teamName = teamMap[team];
          // queens first
          players[teamName] =
            stats.playerMatchStats
                 .filter(p => p.team == team && p.entityType == 3)
                .concat(stats.playerMatchStats
                 .filter(p => p.team == team && p.entityType != 3))
                .map(p => p.nickname);
        }

        const majorStats = ["kills", "berries", "deaths", "snail"];
        const best = {};
        for (const stat of majorStats) {
          const f = (stat == "deaths" ? Math.min : Math.max);
          best[stat] = f(...stats.playerMatchStats.map(p => p[stat]));
        }

        const matchStats = document.createElement("div");
        matchStats.classList.add("matchStats");
        const playerMatchStats = document.createElement("div");
        playerMatchStats.classList.add("playerMatchStats");
        for (const team of teams) {
          const teamMatchStats = document.createElement("div");
          teamMatchStats.classList.add(team);

          for (const nickname of players[team]) {
            const playerStats = stats.playerMatchStats
                                .filter(p => p.nickname == nickname)[0];
            const player = document.createElement("div");
            player.classList.add("player");

            const identification = document.createElement("div");
            identification.classList.add("identification");

            const nameDiv = document.createElement("div");
            nameDiv.classList.add("nickname");
            nameDiv.innerText = nickname;
            identification.appendChild(nameDiv);

            const avatar = document.createElement("div");
            avatar.classList.add("avatar");
            avatar.classList.add("entitySkin-" + playerStats.entitySkin);
            avatar.classList.add("entityType-" + playerStats.entityType);
            avatar.classList.add(playerStats.entityType == 3
                                  ? "queen"
                                  : "worker");
            identification.appendChild(avatar);
            player.appendChild(identification);

            const summaryStats = document.createElement("div");
            summaryStats.classList.add("summaryStats");
            for (const statName of majorStats) {
              const statDisplay = document.createElement("div");
              statDisplay.classList.add(statName);
              const statValue = document.createElement("span");
              statValue.innerText = playerStats[statName];
              statDisplay.appendChild(statValue);
              if (playerStats[statName] == best[statName]) {
                statDisplay.classList.add("best");
              }
              summaryStats.appendChild(statDisplay);
            }
            player.appendChild(summaryStats);

            teamMatchStats.appendChild(player);
          }

          playerMatchStats.appendChild(teamMatchStats);
        }
        matchStats.appendChild(playerMatchStats);
        div.appendChild(matchStats);

        const detailedStats = document.createElement("div");
        detailedStats.classList.add("detailedStats");
        div.appendChild(detailedStats);

        const jsonDisplay = document.createElement("pre");
        jsonDisplay.classList.add("rawJson");
        jsonDisplay.innerText = JSON.stringify(stats, null, 2);
        div.appendChild(jsonDisplay);
      }
    </script>
  </head>
  <body>
    <a id="github" href="https://github.com/dperelman/kqb-stats-viewer">
      Report issues or submit pull requests on GitHub
    </a>
    <button id="openDir" onclick="openDir()">Open directory</button>
    <button id="open" onclick="openFile()">Open file</button>
    <div id="dirhelp">
      Default directories:
      <dl>
        <dt>Windows</dt>
        <dd>C:\Users\%USERPROFILE%\AppData\LocalLow\Liquid Bit, LLC\Killer Queen Black\match-stats</dd>
        <dt>Mac</dt>
        <dd>?</dd>
        <dt>Linux</dt>
        <dd>~/.local/share/Steam/steamapps/compatdata/663670/pfx/drive_c/users/steamuser/AppData/LocalLow/Liquid Bit, LLC/Killer Queen Black/match-stats/</dd>
      </dl>
    </div>
    <div id="navigation" style="display:none;">
      <button id="prev" onclick="loadPrevious()" disabled>&lt; Previous</button>
      <button id="next" onclick="loadNext()" disabled>Next &gt;</button>
      <button id="latest" onclick="loadLatest()" disabled>Jump to Newest ⇉</button>
    </div>
    <h1 id="matchName"><span id="filename"></span></h1>
    <div id="stats"></div>
  </body>
</html>

